name: Build and Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  packages: write

jobs:
  version-check:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      new_tag: ${{ steps.check.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: check
        run: |
          # ì „ì²´ ì»¤ë°‹ ìˆ˜ í™•ì¸
          COUNT=$(git rev-list --count HEAD)
          
          # 10ìœ¼ë¡œ ë‚˜ëˆˆ ëª«ì„ ì£¼ ë²„ì „ìœ¼ë¡œ ì‚¬ìš© (ì˜ˆ: 10íšŒ=v1.0.0, 20íšŒ=v2.0.0)
          VERSION=$((COUNT / 10))
          TAG="v${VERSION}.0.0"
          
          echo "Current Total Commits: $COUNT"
          echo "Target Tag: $TAG"
          echo "new_tag=$TAG" >> $GITHUB_OUTPUT
          
          # ì •í™•íˆ 10ì˜ ë°°ìˆ˜ì¼ ë•Œë§Œ ë¦´ë¦¬ì¦ˆ íŠ¸ë¦¬ê±°
          if [ $((COUNT % 10)) -eq 0 ] && [ $COUNT -gt 0 ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ 10th commit milestone reached. Triggering Release."
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â³ Commit count is $COUNT. Next release at next 10th milestone."
          fi

  build-binaries:
    needs: version-check
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: SimpleServer-Linux
            executable_name: SimpleServer-Linux
          - os: windows-latest
            artifact_name: SimpleServer-Windows
            executable_name: SimpleServer-Windows.exe
          - os: macos-latest
            artifact_name: SimpleServer-MacOS
            executable_name: SimpleServer-MacOS
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            SEP=";"
          else
            SEP=":"
          fi
          PYTHON_PATH=$(python -c "import customtkinter; import os; print(os.path.dirname(customtkinter.__file__))")
          pyinstaller --noconsole --onefile --name "${{ matrix.executable_name }}" \
            --add-data "${PYTHON_PATH}${SEP}customtkinter/" \
            main.py
            
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.executable_name }}

  release:
    needs: [version-check, build-binaries]
    if: needs.version-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version-check.outputs.new_tag }}
          name: Release ${{ needs.version-check.outputs.new_tag }}
          body: |
            ## Simple Server Premium Milestone Release
            ì •ê¸° ìë™ ë°°í¬ (ëˆ„ì  ì»¤ë°‹ 10íšŒ ë‹¨ìœ„)
            
            - **ë²„ì „**: ${{ needs.version-check.outputs.new_tag }}
            - **ë¹Œë“œ ë‚´ì—­**: Linux, Windows, MacOS ë‹¨ì¼ ì‹¤í–‰ íŒŒì¼
            - **ì»¨í…Œì´ë„ˆ**: GHCR ë„ì»¤ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ
          files: |
            artifacts/SimpleServer-Linux/SimpleServer-Linux
            artifacts/SimpleServer-Windows/SimpleServer-Windows.exe
            artifacts/SimpleServer-MacOS/SimpleServer-MacOS
          token: ${{ secrets.GITHUB_TOKEN }}

  docker-ghcr:
    needs: version-check
    if: needs.version-check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.version-check.outputs.new_tag }}
          flavor: |
            latest=auto

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
