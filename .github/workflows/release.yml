name: Build and Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  packages: write

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch

  build-binaries:
    needs: version
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: SimpleServer-Linux
            executable_name: SimpleServer
          - os: windows-latest
            artifact_name: SimpleServer-Windows
            executable_name: SimpleServer.exe
          - os: macos-latest
            artifact_name: SimpleServer-MacOS
            executable_name: SimpleServer
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Build with PyInstaller
        shell: bash
        run: |
          # OS에 따른 경로 구분자 설정 (Windows는 ';', 나머지는 ':')
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            SEP=";"
          else
            SEP=":"
          fi
          
          # CustomTkinter 데이터 경로 찾기
          PYTHON_PATH=$(python -c "import customtkinter; import os; print(os.path.dirname(customtkinter.__file__))")
          
          pyinstaller --noconsole --onefile --name "${{ matrix.executable_name }}" \
            --add-data "${PYTHON_PATH}${SEP}customtkinter/" \
            main.py
            
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.executable_name }}

  release:
    needs: [version, build-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.new_tag }}
          name: Release ${{ needs.version.outputs.new_tag }}
          body: |
            Automated Release for version ${{ needs.version.outputs.new_tag }}
            
            - Built for Linux, Windows, and MacOS.
            - Docker image pushed to GHCR.
          files: |
            artifacts/SimpleServer-Linux/SimpleServer
            artifacts/SimpleServer-Windows/SimpleServer.exe
            artifacts/SimpleServer-MacOS/SimpleServer
          token: ${{ secrets.GITHUB_TOKEN }}

  docker-ghcr:
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.version.outputs.new_tag }}
          # 대소문자 문제 해결
          flavor: |
            latest=auto
            prefix=
            suffix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 저장소 이름이 대문자인 경우를 대비해 소문자 변환 옵션 추가 가능하지만
          # metadata-action에서 이미 처리하도록 설정하는 것이 안전합니다.
